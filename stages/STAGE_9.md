# STAGE 9 — MIDI Export

## Цель
Добавить экспорт музыкального состояния города в стандартный файл `MIDI (.mid)`.

## Зависит от
- Сетка/дороги/здания из этапов 1-3.
- Темп и аудио-параметры из этапов 1 и 5.
- Сериализация состояния из этапа 7.

## MUST
- [ ] Добавить публичный API `ST.MIDI.export()` для генерации и скачивания `.mid`.
- [ ] Отразить BPM проекта в MIDI meta tempo.
- [ ] Экспортировать ноты минимум по 3 транспортам (`car`, `bicycle`, `bus`) в отдельные треки.
- [ ] Преобразовать `pitch` зданий в MIDI note number (с корректным clamp 0..127).
- [ ] Гарантировать валидный заголовок файла `MThd` и хотя бы один `MTrk`.

## SHOULD
- [ ] Добавить `ST.MIDI.exportBlob()` для тестов и интеграций без скачивания.
- [ ] Добавить UI-кнопку `Export MIDI` в transport bar.
- [ ] Добавить выбор PPQ (например 96/192/480) через конфиг.

## Контракты
См. `prompts/claude-code/CONTRACTS.md` (добавить секцию этапа 9).

## Тесты
- `tests/test_stage_9.js` (валидный заголовок, tempo, число треков, диапазон нот).
- Через `tests/runner.html`.

## Done Definition
- MUST закрыты.
- `.mid` открывается в минимум 2 внешних DAW/MIDI viewers без ошибок.
- stage-тесты зелёные, регрессий нет.
