# СПЕЦИФИКАЦИЯ

## Визуал

| Параметр              | Значение                                    |
|-----------------------|---------------------------------------------|
| Canvas                | 640×480 рабочая область                     |
| Тайл                  | 32×32 px                                    |
| Сетка                 | 20×15 тайлов                                |
| Фон                   | `#0a0a12`                                   |
| Линии сетки           | `rgba(255,255,255,0.05)`, 1px               |
| Дороги                | `#1a1a2e`, белый пунктир `dashArray [4,4]`  |
| Toolbar слева         | 200px, `#12122a`                            |
| Property panel справа | 220px, появляется при клике на здание       |
| Transport bar снизу   | 64px                                        |
| Шрифт UI              | Inter, fallback sans-serif                  |

## Здания

| Тип       | Цвет      | Ширина    | Высота (lv1–8)  | Крыша             | Waveform  | Decay |
|-----------|-----------|-----------|------------------|-------------------|-----------|-------|
| sine      | `#64b5f6` | 0.8 тайла | 0.4–1.5 тайла   | Полукруг (arc)    | sine      | 1.2s  |
| square    | `#ef5350` | 0.9 тайла | 0.3–1.2 тайла   | Плоская + труба   | square    | 0.3s  |
| triangle  | `#66bb6a` | 0.6 тайла | 0.6–2.0 тайла   | Острый шпиль      | triangle  | 0.8s  |
| sawtooth  | `#ffa726` | 0.9 тайла | 0.4–1.4 тайла   | Ступенчатая (пила)| sawtooth  | 0.5s  |
| pulse     | `#ab47bc` | 0.3 тайла | 0.8–2.5 тайла   | Антенна + мигание | square    | 0.15s |

## Trigger Flash
- `shadowBlur` 4 → 20 → 4
- Длительность: 150ms
- Easing: ease-out (быстрый вход, плавный выход)

## Звук

| Параметр           | Значение                              |
|--------------------|---------------------------------------|
| Pitch range        | C2 (65Hz) – C6 (1047Hz)              |
| Attack             | 0ms (мгновенный)                     |
| Gain при trigger   | `0.4 × velocity`                     |
| Envelope end       | `exponentialRampToValueAtTime(0.001)` |
| Master compressor  | threshold -24dB, ratio 4:1            |

## Движение машин

| Параметр           | Значение                                                      |
|--------------------|---------------------------------------------------------------|
| Базовая скорость   | 2 тайла/сек при BPM 120                                       |
| Формула            | `(bpm / 120) * baseSpeed * vehicleMultiplier`                  |
| Интерполяция       | Линейная между центрами тайлов                                 |
| Перекрёсток        | Случайный выбор (кроме разворота, если не тупик)               |
| Тупик              | Разворот на 180°                                              |
| Trigger расстояние | Манхэттенское = 1 (машина на road, здание на соседнем тайле)   |

## BPM

| Параметр | Значение |
|----------|----------|
| Default  | 120      |
| Range    | 60–180   |
| Step     | 1        |
| Влияние  | Скорость машин, delay time (sync) |

## Анимации

| Параметр          | Значение  |
|-------------------|-----------|
| Flash duration    | 150ms     |
| Dash speed        | 30 px/sec |
| Particle count    | 30        |
| Particle lifetime | 2000ms    |
| Lerp smoothing    | 0.15      |

---

## ERROR HANDLING

### AudioContext
- MUST создавать по user gesture (click/tap)
- Overlay "Click to start" при первом заходе
- Если `ctx.state === 'suspended'` → `ctx.resume()`

### Canvas
- Фиксированный размер, НЕ масштабировать при resize
- Если окно < canvas → `overflow: auto` на контейнере
- `devicePixelRatio` для retina: `canvas.width = W * dpr`

### Лимиты

| Ресурс          | Лимит | При превышении                      |
|----------------|-------|--------------------------------------|
| Здания         | 50    | Кнопка серая + tooltip               |
| Машины         | 8     | Счётчик красный, Add серая           |
| Голоса (audio) | 8     | Voice stealing: убить самый старый   |
| Дорожные тайлы | 200   | Предупреждение в UI                  |
| Частицы        | 100   | Object pool                          |

### Graceful Degradation
- No Web Audio → сообщение "Браузер не поддерживает Web Audio"
- No rAF → `setTimeout(fn, 16)`
- No localStorage → без автосейва, скрыть save/load
